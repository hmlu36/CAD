@{
    ViewBag.Title = "編輯使用者";
}

<div class="container">
    <br /><h4>編輯使用者</h4>
    <!-- 畫面驗證訊息 -->
    <div class='validation-summary-errors'><ul /></div>

    <div class="form-group row">
        <label class="col-lg-2"><span style="color: red">＊</span>帳號</label>
        <div class="col-lg-2">
            <input type="text" class="form-control" v-model="model.Account">
        </div>
    </div>
    <div class="form-group row">
        <label class="col-lg-2"><span style="color: red">＊</span>姓名</label>
        <div class="col-lg-2">
            <input type="text" class="form-control" v-model="model.Name">
        </div>
    </div>

    <div class="form-group row">
        <label class="col-lg-2"><span style="color: red">＊</span>密碼</label>
        <div class="col-lg-2">
            <input type="password" class="form-control" v-model="model.Password">
        </div>
    </div>
    <div class="form-group row">
        <label class="col-lg-2"><span style="color: red">＊</span>確認密碼</label>
        <div class="col-lg-2">
            <input type="password" class="form-control" v-model="model.ConfirmPassword">
        </div>
    </div>

    <div class="form-group row">
        <label class="col-lg-2">Email</label>
        <div class="col-lg-3">
            <input type="text" class="form-control" v-model="model.Email">
        </div>
    </div>

    <div class="form-group row">
        <label class="col-lg-2">狀態</label>
        <div class="col-lg-8">
            <label class="radio-inline">
                <input type="radio" v-model="model.Status" value="A"> 在職
            </label>
            <label class="radio-inline">
                <input type="radio" v-model="model.Status" value="C"> 離職/停職
            </label>
        </div>
    </div>

    <div class="form-group row">
        <label class="col-lg-2"><span style="color: red">＊</span>權限</label>
        <div class="col-lg-2">
            <template v-for="role in roles">
                <label><input type="checkbox" v-bind:value="role.Code" v-bind:checked="checkRole(role)" v-on:change="checkedRoles(role, $event)" />{{role.Description}}</label>
                <br />
            </template>
        </div>
    </div>

    <div class="text-center">
        <input type="button" class="btn btn-primary" value="儲存" v-on:click="save" />
        <input type="button" class="btn btn-warning" value="上一頁" v-on:click="previousPage" />
    </div>

    <script src="~/js/backendBundle.js"></script>
</div>

<script type="text/javascript">

    new Vue({
        el: '.container',
        data: {
            model: @Html.Raw(Json.Serialize(Model)),
            roles: @Html.Raw(Json.Serialize(ViewBag.Roles))
        },
        created() {
            this.model.ConfirmPassword = this.model.Password;
        },
        methods: {
            // 處理checkbox多選欄位
            checkedRoles(role, $event) {
                if ($event.target.checked) {
                    var userRole = {};
                    userRole.UserId = this.model.Id;
                    userRole.RoleId = role.Id;
                    this.model.UserRoles.push(userRole);
                } else { 
                    this.model.UserRoles = $.grep(this.model.UserRoles, function (e) {
                        return e.RoleId != role.Id;
                    });;
                }
                
               // alert(JSON.stringify(this.model.UserRoles));
            },
            save() {
                var saveUrl = '/Identity/UserEdit';
                //alert(JSON.stringify(this.model));
                ajaxSave(saveUrl, this.model);
            },
            getMapValue(obj, key) {
                if(obj.hasOwnProperty(key))
                return obj[key];
                throw new Error("Invalid map key.");
            },
            checkRole(role) {
                return this.model.UserRoles.some(function (item) {
                    return item.RoleId === role.Id;
                });
            }
        }
    })

</script>